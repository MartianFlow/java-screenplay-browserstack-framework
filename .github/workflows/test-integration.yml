name: test-integration-workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  integration-e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Update serenity.properties with BrowserStack credentials
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          echo "browserstack.user=${BROWSERSTACK_USERNAME}" >> serenity.properties
          echo "browserstack.key=${BROWSERSTACK_ACCESS_KEY}" >> serenity.properties
          echo "userName=${BROWSERSTACK_USERNAME}" >> browserstack.yml
          echo "accessKey=${BROWSERSTACK_ACCESS_KEY}" >> browserstack.yml
          cat serenity.properties
          cat browserstack.yml
          

      - name: Run the composite action
        uses: ./.github/workflows/test_frontend_integration_pipeline.yml
        with:
          command-install: 'mvn clean install -DskipTests'
          command-execute: 'mvn clean verify -D"environment=remote" -P"sample-test"'
          files-to-export: >
            target/site/serenity/serenity-summary.html
            target/logback-reports/logback-execution-report.txt
          prefix-team: 'automation-test-martianFlow'
          debug: false
          environment: 'main'
          path-report-file: 'target/serenity-reports/cucumber_report.json'
          repository: 'java-screenplay-browserstack-framework'
          target-url-zap: 'https://the-internet.herokuapp.com/'
          name-file-report: results.csv
        env:
          DIG_READER_GITHUB_ACCESS_TOKEN: ${{ secrets.DIG_READER_GITHUB_ACCESS_TOKEN }}